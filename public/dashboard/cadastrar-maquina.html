<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastrar Máquina</title>
    <link rel="stylesheet" href="./../css/cabecalho3.css">
    <link rel="stylesheet" href="./../css/cadastrar-maquina.css">

</head>

<body>
    <!-- Cabeçalho -->
    <div class="total-dash">
        <div class="dashboard-bg">
            <div class="dashboard-sidebar">
                <div class="dashboard-logo"></div>
                <div class="dashboard-sidebar-btns">
                    <a href="alertas.html" class="dashboard-sidebar-btn">
                        <div class="icon-alert"></div>
                        <h3>Alertas</h3>
                    </a>
                    <a href="conta.html" class="dashboard-sidebar-btn">
                        <div class="icon-user"></div>
                        <h3>Conta</h3>
                    </a>
                    <a href="dashboard-alto.html" class="dashboard-sidebar-btn">
                        <div class="icon-dashboard"></div>
                        <h3>Painel de <br> Controle</h3>
                    </a>
                    <a href="relatorios.html" class="dashboard-sidebar-btn">
                        <div class="icon-relatory"></div>
                        <h3>Relatórios</h3>
                    </a>
                    <a href="suporte.html" class="dashboard-sidebar-btn">
                        <div class="icon-support"></div>
                        <h3>Suporte</h3>
                    </a>
                </div>
                <a href="/public/index.html" class="dashboard-logout">
                    <div class="icon-logout"></div>
                    <h3>Logout</h3>
                </a>
            </div>
            <!-- Cabeçalho topo -->
            <div class="dashboard-low-right-side">
                <div class="dashboard-topbar">
                    <a href="dashboard-alto.html" class="btn-voltar">
                        Painel de controle - Servidor
                    </a>
                    <div class="btns-topbar">
                        <!-- <a id="btnCadsatrarMaquina" href="cadastrar-maquina.html" class="btn-cadastrar-maquina">
                        Cadastrar Máquina
                    </a> -->
                        <!-- <a href="relatorios.html" class="btn-gerar-relatorio">
                            Gerar relatorio
                        </a> -->
                        <div class="btn-padrao">
                            <button class="btn-notificacao">
                            </button>
                            <a href="conta.html" class="btn-conta">
                            </a>
                        </div>
                    </div>
                </div>
                <!-- Fim Cabeçalho -->


                <div class="box-fundo-dash">
                    <div class="box-fundo">
                        <div class="box-cadastrar">
                            <h2>CADASTRO DE MÁQUINA</h2>

                            <form class="form-maquina" onsubmit="cadastrarMaquina(event)">
                                <div class="campo-maquina"></div>
                                <label for="nome-maquina">Nome</label>
                                <input type="text" id="nome-maquina" name="nome" placeholder="PROD-WEB-01">

                                <div class="campo-maquina"></div>
                                <label for="nome-maquina">HostName</label>
                                <input type="text" id="host-maquina" placeholder="SERVER-001">

                                <div class="campo-maquina"></div>
                                <label for="mac-maquina">Mac Adress</label>
                                <input type="text" id="mac-maquina" placeholder="001A2B3C4D5E">

                                <div class="campo-maquina"></div>
                                <label for="ip-maquina">Endereço de IP</label>
                                <input type="text" id="ip-maquina" placeholder="192.168.1.10">

                                <button type="submit" class="btd-cadastrar">Cadastrar</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="modalErro" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Erro</h3>
                <span class="modal-close" onclick="fecharModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p id="modalErroMessage"></p>
            </div>
            <div class="modal-footer">
                <button class="btn-fechar" onclick="fecharModal()">Fechar</button>
            </div>
        </div>
    </div>


    <script>

        function mostrarErro(mensagem) {
            const modal = document.getElementById('modalErro');
            const mensagemElement = document.getElementById('modalErroMessage');
            mensagemElement.textContent = mensagem;
            modal.style.display = 'block';
        }

        function fecharModal() {
            const modal = document.getElementById('modalErro');
            modal.style.display = 'none';
        }

        window.onclick = function (event) {
            const modal = document.getElementById('modalErro');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        async function cadastrarMaquina(event) {
            event.preventDefault();

            const nome = document.getElementById('nome-maquina').value.trim();
            const hostname = document.getElementById('host-maquina').value.trim();
            const mac = document.getElementById('mac-maquina').value.trim();
            const ip = document.getElementById('ip-maquina').value.trim();

            if (!nome || !hostname || !mac || !ip) {
                mostrarErro('Por favor, preencha todos os campos.');
                return;
            }

            const macRegex = /^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/;
            if (!macRegex.test(mac)) {
                mostrarErro('Formato de MAC address inválido. Use o formato XX:XX:XX:XX:XX:XX');
                return;
            }

            const hostNumerico = javaStringHashCodeNonNegative(hostname);
            const fkEmpresa = sessionStorage.getItem("FK_EMPRESA");

            try {
                const response = await fetch(`/usuarios/cadastrarMaquina`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ identificador: nome, hostNumerico, mac, ip, fkEmpresa }),
                });

                if (!response.ok) throw new Error('Erro ao cadastrar máquina');

                await cadastrarComponente(hostNumerico);
                window.location.href = 'dashboard-alto.html';
            } catch (error) {
                mostrarErro('Erro ao cadastrar máquina: ' + error.message);
            }
        }

        async function cadastrarComponente(hostNumerico) {
            try {
                const response = await fetch(`/usuarios/cadastrarComponentes`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ hostNumerico }),
                });
                if (!response.ok) throw new Error('Erro ao cadastrar Componente');
            } catch (error) {
                console.error(error);
                mostrarErro('Erro ao cadastrar componente: ' + error.message);
            }
        }
    </script>

</body>

</html>