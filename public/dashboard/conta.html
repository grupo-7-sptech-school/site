<!DOCTYPE html>
<html lang="pt-br">

<head>
  <link rel="shortcut icon" href="../assets/icon/logo-branca.ico" type="image/x-icon">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SolarData | Conta</title>

  <link rel="stylesheet" href="./../css/modal.css">
  <link rel="stylesheet" href="./../css/cabecalho3.css">
  
  <script src="../js/sessao.js"></script>
  <script src="./../js/alerta.js"></script>

  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">

  <!-- FONT AWESOME -->
  <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
</head>

<body>
  <!-- Cabeçalho -->
  <div class="total-dash">
    <div class="dashboard-bg">
      <div class="dashboard-sidebar">
        <div class="dashboard-logo"></div>
        <div class="dashboard-sidebar-btns">
          <a href="alertas.html" class="dashboard-sidebar-btn">
            <div class="icon-alert"></div>
            <h3>Alertas</h3>
          </a>
          <a href="conta.html" class="dashboard-sidebar-btn">
            <div class="icon-user"></div>
            <h3>Conta</h3>
          </a>
          <a href="dashboard-alto.html" class="dashboard-sidebar-btn">
            <div class="icon-dashboard"></div>
            <h3>Painel de <br> Controle</h3>
          </a>
          <a href="suporte.html" class="dashboard-sidebar-btn">
            <div class="icon-support"></div>
            <h3>Suporte</h3>
          </a>
        </div>
        <a href="/public/index.html" class="dashboard-logout">
          <div class="icon-logout"></div>
          <h3>Logout</h3>
        </a>
      </div>

      <!-- Cabeçalho topo -->
      <div class="dashboard-low-right-side">
        <div class="dashboard-topbar">
          <a href="#" class="btn-voltar">
            Conta - SolarData
          </a>
          <div class="btns-topbar">
            <div class="btn-padrao">
              <button id="btnGerenciarUsuarios" class="btn-user">
                Gerenciamento usuario
              </button>
              <button class="btn-notificacao">
              </button>
              <a href="conta.html" class="btn-conta">
              </a>
            </div>
          </div>
        </div>
        
        <div id="modalUsuarios" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h2>Gerenciamento de Usuários</h2>
              <span class="close">&times;</span>
            </div>
            <div class="modal-body">
              <div class="form-adicionar-usuario">
                <h3>Adicionar Novo Usuário</h3>
                <form id="formNovoUsuario">
                  <div class="form-group">
                    <label for="email">E-mail:</label>
                    <input type="email" id="email" name="email" required placeholder="exemplo@empresa.com">
                  </div>
                  <div class="form-group">
                    <label for="senha">Senha:</label>
                    <input type="password" id="senha" name="senha" required placeholder="**********">
                  </div>
                  <div class="form-group">
                    <label for="permissao">Tipo de Permissão:</label>
                    <select id="permissao" name="permissao" required>
                      <option value="">Selecione o tipo de permissão...</option>
                      <option value="admin">Administrador</option>
                      <option value="usuario">Usuário</option>
                    </select>
                  </div>
                  <button type="submit" class="btn-adicionar">Adicionar Usuário</button>
                </form>
              </div>

              <div class="lista-usuarios">
                <h3>Usuários do Sistema</h3>
                <div class="tabela-usuarios">
                  <table>
                    <thead>
                      <tr>
                        <th>E-mail</th>
                        <th>Tipo de Permissão</th>
                        <th>Ações</th>
                      </tr>
                    </thead>
                    <tbody id="tabelaUsuarios">
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="modalNotificacoes">
          <div class="modal-content">
            <div id="alertasContainer"></div>
            <button id="btnFecharModal">Fechar</button>
          </div>
        </div>

      </div>
    </div>
  </div>

</body>

</html>


<script>
  const fkTipoUsuario = sessionStorage.getItem("FK_TIPO_USUARIO");

  document.addEventListener("DOMContentLoaded", () => {
    const btnNotificacao = document.querySelector('.btn-notificacao');
    const modalNotificacoes = document.getElementById('modalNotificacoes');
    const btnFecharModal = document.getElementById('btnFecharModal');
    const alertasContainer = document.getElementById('alertasContainer');

    if (Number(fkTipoUsuario) !== 1) {
        const btnGerenciarUsuarios = document.getElementById("btnGerenciarUsuarios");
        if (btnGerenciarUsuarios) {
            btnGerenciarUsuarios.style.display = "none"; 
        }
    }  

    const alertasMock = [
        { identificador: "Server-SP01", componenteNome: "CPU", captura: 87.5, estado: "ALERTA CRITICO", dtHora: "2025-10-28T21:05:17" },
        { identificador: "Server-SP02", componenteNome: "RAM", captura: 82.1, estado: "ALERTA PREVENTIVO", dtHora: "2025-10-28T21:03:12" },
        { identificador: "Server-SP03", componenteNome: "DISCO", captura: 91.3, estado: "ALERTA CRITICO", dtHora: "2025-10-28T21:01:45" },
        { identificador: "Server-SP01", componenteNome: "CPU", captura: 68.9, estado: "ALERTA PREVENTIVO", dtHora: "2025-10-28T21:00:32" }
    ];

    function formatarData(iso) {
        if (!iso) return "—";
        const d = new Date(iso);
        if (isNaN(d)) return "—";
        return d.toLocaleString("pt-BR", { day: "2-digit", month: "2-digit", year: "numeric", hour: "2-digit", minute: "2-digit" });
    }

    function carregarAlertas() {
        alertasContainer.innerHTML = ""; 
        if (!alertasMock.length) {
            alertasContainer.innerHTML = "<p class='text-muted text-center'>Nenhum alerta.</p>";
            return;
        }
        alertasMock.forEach(a => {
            const tipoClasse = a.estado === "ALERTA CRITICO" ? "danger" : a.estado === "ALERTA PREVENTIVO" ? "warning" : "success";
            const div = document.createElement("div");
            div.className = `alerta-item ${tipoClasse}`;
            div.innerHTML = `
                <strong>${a.identificador}</strong>
                <small style="display:block;margin-top:4px;">${a.componenteNome} • <b>${a.captura}%</b></small>
                <div style="margin-top:6px;"><small>Estado: <b>${a.estado}</b></small></div>
                <small style="display:block;margin-top:6px;color:#555">${formatarData(a.dtHora)}</small>
            `;
            alertasContainer.appendChild(div);
        });
    }



    btnNotificacao.addEventListener("click", () => {
        modalNotificacoes.classList.add("active"); 
        carregarAlertas(); 
    });

    btnFecharModal.addEventListener("click", () => modalNotificacoes.classList.remove("active"));
    modalNotificacoes.addEventListener("click", (e) => { if (e.target === modalNotificacoes) modalNotificacoes.classList.remove("active"); });



    
    const modalUsuarios = document.getElementById('modalUsuarios');
    const btnAbrir = document.querySelector('.btn-user');
    const spanFechar = document.querySelector('.close');
    const formNovoUsuario = document.getElementById('formNovoUsuario');
    const tabelaUsuarios = document.getElementById('tabelaUsuarios');

    let usuarios = [
        { email: 'admin@solardata.com', permissao: 'admin' },
        { email: 'analista1@solardata.com', permissao: 'usuario' },
    ];

    btnAbrir.addEventListener('click', function() {
        modalUsuarios.style.display = 'block';
        carregarUsuarios();
    });

    spanFechar.addEventListener('click', function() {
        modalUsuarios.style.display = 'none';
    });

    window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });

            function carregarUsuarios() {
                tabelaUsuarios.innerHTML = '';
                usuarios.forEach((usuario, index) => {
                    const tr = document.createElement('tr');
                    
                    const classePermissao = `permissao-${usuario.permissao}`;
                    const textoPermissao = usuario.permissao === 'admin' ? 'Administrador' : 
                                        usuario.permissao === 'usuario' ? 'Usuário' : 'Visualizador';
                    
                    tr.innerHTML = `
                        <td>${usuario.email}</td>
                        <td><span class="${classePermissao}">${textoPermissao}</span></td>
                        <td>
                            <button class="btn-acao btn-editar" onclick="editarUsuario(${index})">Editar</button>
                            <button class="btn-acao btn-excluir" onclick="excluirUsuario(${index})">Excluir</button>
                        </td>
                    `;
                    tabelaUsuarios.appendChild(tr);
                });
            }

            formNovoUsuario.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const email = document.getElementById('email').value;
                const permissao = document.getElementById('permissao').value;
                
                if (email && permissao) {
                    usuarios.push({ email, permissao });
                    carregarUsuarios();
                    formNovoUsuario.reset();
                    
                    console.log('Novo usuário:', { email, permissao });
                    alert('Usuário adicionado com sucesso!');
                }
            });

            window.editarUsuario = function(index) {
                const usuario = usuarios[index];
                const novoEmail = prompt('Editar e-mail:', usuario.email);
                const novaPermissao = prompt('Editar permissão (admin/usuario/visualizador):', usuario.permissao);
                
                if (novoEmail && novaPermissao) {
                    usuarios[index] = { email: novoEmail, permissao: novaPermissao };
                    carregarUsuarios();
                    alert('Usuário atualizado com sucesso!');
                }
            };

            window.excluirUsuario = function(index) {
                if (confirm('Tem certeza que deseja excluir este usuário?')) {
                    usuarios.splice(index, 1);
                    carregarUsuarios();
                    alert('Usuário excluído com sucesso!');
                }
            };

            carregarUsuarios();
        });

</script>