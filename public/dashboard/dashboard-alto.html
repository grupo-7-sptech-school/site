<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/logo-branca.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SolarData | Painel de controle</title>

    <!-- CSS -->
    <link rel="stylesheet" href="./../css/cabecalho3.css">
    <link rel="stylesheet" href="./../css/dash-alto.css">
    <link rel="stylesheet" href="./../css/dashboards.css">

    <!-- Script -->
    <script src="../js/sessao.js"></script>
    <script src="./../js/alerta.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!--FONT AWESOME-->
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>

    <!-- Links -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">






</head>

<!-- <body onload=" atualizarFeed()"> -->

<body>
    <!-- Cabeçalho -->
    <div class="total-dash">
        <div class="dashboard-bg">
            <div class="dashboard-sidebar">
                <div class="dashboard-logo"></div>
                <div class="dashboard-sidebar-btns">
                    <a href="alertas.html" class="dashboard-sidebar-btn">
                        <div class="icon-alert"></div>
                        <h3>Alertas</h3>
                    </a>
                    <a href="conta.html" class="dashboard-sidebar-btn">
                        <div class="icon-user"></div>
                        <h3>Conta</h3>
                    </a>
                    <a href="dashboard-alto.html" class="dashboard-sidebar-btn">
                        <div class="icon-dashboard"></div>
                        <h3>Painel de <br> Controle</h3>
                    </a>
                    <a href="relatorios.html" class="dashboard-sidebar-btn">
                        <div class="icon-relatory"></div>
                        <h3>Relatórios</h3>
                    </a>
                    <a href="suporte.html" class="dashboard-sidebar-btn">
                        <div class="icon-support"></div>
                        <h3>Suporte</h3>
                    </a>
                </div>
                <a href="/public/index.html" class="dashboard-logout">
                    <div class="icon-logout"></div>
                    <h3>Logout</h3>
                </a>
            </div>
            <!-- Cabeçalho topo -->
            <div class="dashboard-low-right-side">
                <div class="dashboard-topbar">
                    <a href="dashboard-alto.html" class="btn-voltar">
                        Painel de controle - Servidor
                    </a>
                    <div class="btns-topbar">
                        <a id="btnCadsatrarMaquina" href="cadastrar-maquina.html" class="btn-cadastrar-maquina">
                        Cadastrar Máquina
                    </a>
                        <!-- <a href="relatorios.html" class="btn-gerar-relatorio">
                            Gerar relatorio
                        </a> -->
                        <div class="btn-padrao">
                            <button class="btn-notificacao">
                            </button>
                            <a href="conta.html" class="btn-conta">
                            </a>
                        </div>
                    </div>
                </div>
                <!-- Fim Cabeçalho -->
                <div class="box-dashboard">

                    <div class="box-notificacao">

                        <!-- Topo  quadro de monitoramento -->
                        <div class="container-maquinas">
                            <div class="header-maquinas">
                                <div class="box-id">
                                    <p>HOSTNAME</p>
                                </div>
                                <div class="box-nome">
                                    <p>IDENTIFICADOR</p>
                                </div>
                                <div class="box-uptime">
                                    <p>IP</p>
                                </div>
                                <div class="box-uptime">
                                    <p>DATA DE CRIAÇÃO</p>
                                </div>
                                <div class="box-ocorrencia">
                                    <p>ULTIMA OCORRÊNCIA</p>
                                </div>
                                <div class="box-rack">
                                    <p>USO DE CPU</p>
                                </div>
                                <div class="box-rack">
                                    <p>USO DE RAM</p>
                                </div>
                                <div class="box-status">
                                    <p>STATUS</p>
                                </div>
                            </div>

                            <!-- as linhas virão aqui -->
                            <div id="lista-maquinas"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    Cabeçalho
    <div class="dashboard-bg">
        <div class="dashboard-sidebar">
            <div class="dashboard-logo"></div>
            <div class="dashboard-sidebar-btns">
                <a href="alertas.html" class="dashboard-sidebar-btn">
                    <div class="icon-alert"></div>
                    <h3>Alertas</h3>
                </a>
                <a href="conta.html" class="dashboard-sidebar-btn">
                    <div class="icon-user"></div>
                    <h3>Conta</h3>
                </a>
                <a href="dashboard-alto.html" class="dashboard-sidebar-btn">
                    <div class="icon-dashboard"></div>
                    <h3>Painel de Controle</h3>
                </a>
                <a href="relatorios.html" class="dashboard-sidebar-btn">
                    <div class="icon-relatory"></div>
                    <h3>Relatórios</h3>
                </a>
                <a href="suporte.html" class="dashboard-sidebar-btn">
                    <div class="icon-support"></div>
                    <h3>Suporte</h3>
                </a>
            </div>
            <a href="index.html" class="dashboard-logout">
                <div class="icon-logout"></div>
                <h3>Logout</h3>
            </a>
        </div>
        Cabeçalho topo
        <div class="dashboard-low-right-side">
            <div class="dashboard-topbar">
                <a href="dashboard-alto.html" class="btn-voltar">
                    Painel de controle - Servidor
                </a>
                <div class="btns-topbar">
                    <a id="btnCadsatrarMaquina" href="cadastrar-maquina.html" class="btn-cadastrar-maquina">
                        Cadastrar Máquina
                    </a>
                    <button class="btn-notificacao">
                    </button>
                    <a href="conta.html" class="btn-conta">
                        <div class="icon-user2"></div>
                    </a>

                </div>
            </div>
            Fim Cabeçalho

        </div>

    </div>
    </div>
    <div id="modalNotificacoes">
        <div class="modal-content">
            <div id="alertasContainer"></div>
            <button id="btnFecharModal">Fechar</button>
        </div>
    </div>
</body>

<script>
    const btnNotificacao = document.querySelector('.btn-notificacao');
    const modal = document.getElementById('modalNotificacoes');
    const btnFecharModal = document.getElementById('btnFecharModal');
    const alertasContainer = document.getElementById('alertasContainer');

    // Função para abrir o modal
    btnNotificacao.addEventListener('click', () => {
        modal.classList.add('active');
        carregarAlertas();
    });

    // Fechar o modal
    btnFecharModal.addEventListener('click', () => modal.classList.remove('active'));

    // Fecha ao clicar fora da caixa
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.classList.remove('active');
    });

    // Carregar alertas simulados
    async function carregarAlertas() {
        alertasContainer.innerHTML = "<p class='loading'>Carregando alertas...</p>";

        try {
            const resposta = await fetch("/usuarios/puxarAlerta");
            if (!resposta.ok) throw new Error("Erro ao buscar alertas do servidor.");

            const alertas = await resposta.json();
            alertasContainer.innerHTML = "";

            if (alertas.length === 0) {
                alertasContainer.innerHTML = "<p class='text-muted text-center'>Nenhum alerta encontrado.</p>";
                return;
            }

            alertas.forEach(alerta => {
                let tipoClasse = "";
                switch (alerta.estado) {
                    case "CRITICO":
                        tipoClasse = "danger";
                        break;
                    case "ALERTA":
                        tipoClasse = "warning";
                        break;
                    case "NORMAL":
                        tipoClasse = "success";
                        break;
                    default:
                        tipoClasse = "success";
                }

                const dataFormatada = new Date(alerta.dtHora).toLocaleString("pt-BR");


                const div = document.createElement("div");
                div.className = `alerta-item ${tipoClasse}`;
                div.innerHTML = `
                <strong>Identificador da máquina:</strong> <small>${alerta.identificador || "Desconhecida"}</small><br>
                <strong>${alerta.componenteNome || "Componente"}:</strong> ${alerta.captura || "Sem dados."}<br>
                <strong>Estado:</strong> <small>${alerta.estado || "DESCONHECIDO"}</small><br>
                <small>${new Date(alerta.dtHora).toLocaleString("pt-BR")}</small>
            `;

                alertasContainer.appendChild(div);
            });
        } catch (error) {
            console.error("Erro ao carregar alertas:", error);
            alertasContainer.innerHTML = `<p class="text-danger text-center">Erro ao carregar alertas.</p>`;
        }
    }





    function formatarData(dataISO) {
        if (!dataISO) return "—";  // filtra para ver se tem o dado ou não
        const data = new Date(dataISO);
        if (isNaN(data)) return "—";  // filtra para ver se tem o dado ou não
        return data.toLocaleString("pt-BR", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
        });
    }





    async function carregarMaquinas() {

        var container = document.getElementById("lista-maquinas");
        container.innerHTML = "<p class='text-muted text-center'>Carregando máquinas...</p>";

        try {
            var respostaRecebida = await fetch("/usuarios/puxarMaquinas");
            var maquinas = await respostaRecebida.json();

            if (maquinas.length == 0) {
                container.innerHTML = "<p class='text-center text-muted'>Nenhuma máquina cadastrada.</p>";
                return;
            }

            container.innerHTML = "";

            for (let index = 0; index < maquinas.length; index++) {
                const m = maquinas[index];

                var host = m["HostName"] || "—";
                var ident = m["Identificador"] || "—";
                var ip = m["IP"] || "—";
                var dataCriacao = m["Data de Criação"];
                var ultimaOcorrencia = m["Data do Último Alerta"];

                var dataCriacaoFormatada = formatarData(dataCriacao);
                var ultimaOcorrenciaFormatada = formatarData(ultimaOcorrencia);

                var cpuValor = m["CPU Atual (%)"] || 0;
                var ramValor = m["RAM Atual (%)"] || 0;
                var usoCPU = `${cpuValor}%`;
                var usoRAM = `${ramValor}%`;

                var estado = "";
                if (cpuValor > 80 || ramValor > 90) {
                    estado = "critico";
                } else if ((cpuValor >= 70 && cpuValor <= 80) || (ramValor >= 80 && ramValor <= 90)) {
                    estado = "alerta";
                } else if (cpuValor < 10 && ramValor < 10) {
                    estado = "ocioso";
                } else {
                    estado = "normal";
                }

                const linhaBagulho = document.createElement("div"); // chama a div especifica para cada linha
                linhaBagulho.classList.add("line-notifica");  // adiciona css a linha especifica 

                linhaBagulho.innerHTML = `
        <div class="box-id"><p>${host}</p></div>
        <div class="box-nome"><p>${ident}</p></div>
        <div class="box-uptime"><p>${ip}</p></div>
        <div class="box-uptime"><p>${dataCriacaoFormatada}</p></div>
        <div class="box-ocorrencia"><p>${ultimaOcorrenciaFormatada}</p></div>
        <div class="box-rack"><p>${usoCPU}</p></div>
        <div class="box-rack"><p>${usoRAM}</p></div>
        <div class="box-status"><p class="status ${estado}">${estado.toUpperCase()}</p></div>
      `;

                linhaBagulho.onclick = function () {
                    location.replace(`dashboard.html?id=${m["host"]}`);  // assim que ele clica ele vai para a a dash especifica do ID
                }

                container.appendChild(linhaBagulho);  // adiciona a nova linha de info no fim da página, com as coisas especificas e tal
            }
        } catch (e) {
            console.error(e);
            container.innerHTML = "<p style='color:red;'>Erro ao carregar máquinas.</p>";
        }
    }


    carregarMaquinas();

</script>